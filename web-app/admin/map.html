<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carte Interactive - Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/admin.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>

<body>
    <div class="admin-layout">
        <!-- Sidebar (same as dashboard) -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <div class="sidebar-logo-icon">ğŸ—‘ï¸</div>
                    <span>Waste AI</span>
                </div>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Menu Principal</div>
                    <a href="dashboard.html" class="nav-item">
                        <span class="nav-icon">ğŸ“Š</span>
                        <span>Tableau de bord</span>
                    </a>
                    <a href="map.html" class="nav-item active">
                        <span class="nav-icon">ğŸ—ºï¸</span>
                        <span>Carte Interactive</span>
                    </a>
                    <a href="reports.html" class="nav-item">
                        <span class="nav-icon">ğŸ“‹</span>
                        <span>Gestion Signalements</span>
                    </a>
                    <a href="collections.html" class="nav-item">
                        <span class="nav-icon">ğŸš›</span>
                        <span>Collectes & ItinÃ©raires</span>
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Administration</div>
                    <a href="users.html" class="nav-item">
                        <span class="nav-icon">ğŸ‘¥</span>
                        <span>Gestion Utilisateurs</span>
                    </a>
                    <a href="analytics.html" class="nav-item">
                        <span class="nav-icon">ğŸ“ˆ</span>
                        <span>Analyses & Rapports</span>
                    </a>
                    <a href="settings.html" class="nav-item">
                        <span class="nav-icon">âš™ï¸</span>
                        <span>ParamÃ¨tres</span>
                    </a>
                </div>
            </nav>

            <div class="sidebar-footer">
                <div class="user-profile">
                    <div class="user-avatar" id="user-avatar">A</div>
                    <div class="user-info">
                        <div class="user-name" id="user-name">Admin User</div>
                        <div class="user-role" id="user-role">Administrateur</div>
                    </div>
                    <button class="btn-icon btn-secondary" id="logout-btn" title="DÃ©connexion">ğŸšª</button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="page-header">
                <div>
                    <h1 class="page-title">Carte Interactive</h1>
                    <p class="page-subtitle">Visualisation gÃ©ographique des signalements</p>
                </div>
            </div>

            <!-- Map Filters -->
            <div class="filters mb-lg">
                <div class="filter-group">
                    <label style="color: var(--text-gray); margin-right: 0.5rem;">Type:</label>
                    <select class="form-select" id="filter-type" style="width: auto;">
                        <option value="">Tous les types</option>
                        <option value="DÃ©chet mÃ©nager">DÃ©chets mÃ©nagers</option>
                        <option value="DÃ©chets verts">DÃ©chets verts</option>
                        <option value="DÃ©chets de construction">Construction</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label style="color: var(--text-gray); margin-right: 0.5rem;">Statut:</label>
                    <select class="form-select" id="filter-status" style="width: auto;">
                        <option value="">Tous les statuts</option>
                        <option value="EN_ATTENTE">En attente</option>
                        <option value="EN_COURS">En cours</option>
                        <option value="TERMINE">TerminÃ©</option>
                    </select>
                </div>

                <div style="flex: 1;"></div>

                <button class="btn btn-primary" onclick="refreshMap()">
                    <span>ğŸ”„</span>
                    Actualiser
                </button>
            </div>

            <!-- Map Container -->
            <div class="map-container" style="height: calc(100vh - 250px);">
                <div id="map"></div>
            </div>

            <!-- Legend -->
            <div class="card mt-lg">
                <div class="card-header">
                    <h3 class="card-title">LÃ©gende</h3>
                </div>
                <div class="card-body">
                    <div class="flex gap-lg" style="flex-wrap: wrap;">
                        <div class="flex items-center gap-sm">
                            <div style="width: 24px; height: 24px; background-color: #f59e0b; border-radius: 50%;">
                            </div>
                            <span>En attente</span>
                        </div>
                        <div class="flex items-center gap-sm">
                            <div style="width: 24px; height: 24px; background-color: #3b82f6; border-radius: 50%;">
                            </div>
                            <span>En cours</span>
                        </div>
                        <div class="flex items-center gap-sm">
                            <div style="width: 24px; height: 24px; background-color: #10b981; border-radius: 50%;">
                            </div>
                            <span>TerminÃ©</span>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="../js/app.js"></script>
    <script>
        // Check authentication
        if (!Utils.requireAuth('ADMIN')) {
            window.location.href = 'login.html';
        }

        // Initialize map centered on Algiers
        const map = L.map('map').setView([36.7538, 3.0588], 13);

        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);

        // Function to get marker color based on status
        function getMarkerColor(status) {
            switch (status) {
                case 'EN_ATTENTE': return '#f59e0b';
                case 'EN_COURS': return '#3b82f6';
                case 'TERMINE': return '#10b981';
                default: return '#9ca3af';
            }
        }

        // Function to create custom marker icon
        function createCustomIcon(status) {
            const color = getMarkerColor(status);
            return L.divIcon({
                className: 'custom-marker',
                html: `<div style="
          width: 30px;
          height: 30px;
          background-color: ${color};
          border: 3px solid white;
          border-radius: 50%;
          box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        "></div>`,
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });
        }

        let markers = [];

        // Function to load markers
        function loadMarkers() {
            // Clear existing markers
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];

            // Get filters
            const typeFilter = document.getElementById('filter-type').value;
            const statusFilter = document.getElementById('filter-status').value;

            // Get filtered reports
            const reports = AppData.getReports({
                type: typeFilter,
                status: statusFilter
            });

            // Add markers
            reports.forEach(report => {
                const marker = L.marker(
                    [report.latitude, report.longitude],
                    { icon: createCustomIcon(report.status) }
                ).addTo(map);

                // Add popup
                marker.bindPopup(`
          <div class="map-marker-info">
            <div class="marker-title">${report.titre}</div>
            <div class="marker-description">${report.description}</div>
            <div style="margin-top: 0.5rem;">
              <span class="badge ${Utils.getStatusBadgeClass(report.status)}">${Utils.getStatusLabel(report.status)}</span>
            </div>
            <div style="margin-top: 0.5rem; font-size: 0.75rem; color: #9ca3af;">
              ${report.type} â€¢ ${Utils.formatDate(report.createdAt)}
            </div>
            <button class="btn btn-sm btn-primary" style="margin-top: 0.5rem; width: 100%;" onclick="window.location.href='reports.html?id=${report.id}'">
              Voir DÃ©tails
            </button>
          </div>
        `);

                markers.push(marker);
            });

            // Fit map to markers if any exist
            if (markers.length > 0) {
                const group = new L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }

        // Function to refresh map
        function refreshMap() {
            loadMarkers();
            Utils.showNotification('Carte actualisÃ©e', 'Les donnÃ©es ont Ã©tÃ© mises Ã  jour', 'success');
        }

        // Add event listeners for filters
        document.getElementById('filter-type').addEventListener('change', loadMarkers);
        document.getElementById('filter-status').addEventListener('change', loadMarkers);

        // Initial load
        loadMarkers();
    </script>
</body>

</html>